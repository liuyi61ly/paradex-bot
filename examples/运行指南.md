# 套利策略配置和运行指南

## 📋 配置地址和私钥

### 方式1：直接在命令行设置（推荐用于测试）

在运行脚本前，在终端中设置环境变量：

```bash
# 设置账户1的配置
export ACCOUNT1_L1_ADDRESS="0x你的账户1的以太坊地址"
export ACCOUNT1_L1_PRIVATE_KEY="0x你的账户1的私钥"

# 设置账户2的配置
export ACCOUNT2_L1_ADDRESS="0x你的账户2的以太坊地址"
export ACCOUNT2_L1_PRIVATE_KEY="0x你的账户2的私钥"

# 可选：设置交易参数
export MARKET="BTC-USD-PERP"           # 交易市场
export MIN_SPREAD_THRESHOLD="0"        # 价差阈值（0表示价差必须为0）

# 你的策略配置：较少账户资金的90%作为两个账户的保证金，目标50x，1秒后平仓
export USE_DYNAMIC_SIZE="true"
export FUNDS_RATIO="0.9"
export TARGET_LEVERAGE="50"
export CLOSE_AFTER_SECONDS="1"

# 固定下单数量（仅当 USE_DYNAMIC_SIZE=false 时生效）
export TRADE_SIZE="0.01"

export LOG_FILE="false"                # 是否使用文件日志
```

**完整示例：**
```bash
export ACCOUNT1_L1_ADDRESS="0x1234567890123456789012345678901234567890"
export ACCOUNT1_L1_PRIVATE_KEY="0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
export ACCOUNT2_L1_ADDRESS="0x0987654321098765432109876543210987654321"
export ACCOUNT2_L1_PRIVATE_KEY="0xfedcba0987654321fedcba0987654321fedcba0987654321fedcba0987654321"
export USE_DYNAMIC_SIZE="true"
export FUNDS_RATIO="0.9"
export TARGET_LEVERAGE="50"
export CLOSE_AFTER_SECONDS="1"
```

### 方式2：创建 .env 文件（推荐用于生产环境）

在 `examples` 目录下创建 `.env` 文件：

```bash
cd examples
nano .env  # 或使用其他编辑器
```

在 `.env` 文件中添加：

```bash
# 账户1配置
ACCOUNT1_L1_ADDRESS=0x你的账户1的以太坊地址
ACCOUNT1_L1_PRIVATE_KEY=0x你的账户1的私钥

# 账户2配置
ACCOUNT2_L1_ADDRESS=0x你的账户2的以太坊地址
ACCOUNT2_L1_PRIVATE_KEY=0x你的账户2的私钥

# 交易配置（可选）
MIN_SPREAD_THRESHOLD=0
MARKET=BTC-USD-PERP

# 动态下单（推荐：匹配你的需求）
USE_DYNAMIC_SIZE=true
FUNDS_RATIO=0.9
TARGET_LEVERAGE=50
CLOSE_AFTER_SECONDS=1

# 固定下单数量（仅当 USE_DYNAMIC_SIZE=false 时生效）
TRADE_SIZE=0.01
LOG_FILE=false
```

然后加载环境变量并运行：

```bash
# 加载 .env 文件（需要安装 python-dotenv，或手动source）
source .env  # 如果使用bash/zsh
# 或者使用 python-dotenv（需要先安装：pip install python-dotenv）

# 运行脚本
python arbitrage_btc_usdt.py
```

### 方式3：修改脚本直接配置（不推荐，仅用于测试）

⚠️ **警告：不要在生产环境中使用此方法，私钥会暴露在代码中！**

直接修改脚本文件：

```python
# 在 arbitrage_btc_usdt.py 中修改这些行
ACCOUNT1_L1_ADDRESS = "0x你的账户1地址"  # 替换 os.getenv(...)
ACCOUNT1_L1_PRIVATE_KEY = "0x你的账户1私钥"
ACCOUNT2_L1_ADDRESS = "0x你的账户2地址"
ACCOUNT2_L1_PRIVATE_KEY = "0x你的账户2私钥"
```

## 🚀 运行脚本

### 步骤1：进入项目目录

```bash
cd /Users/patrick/Desktop/paradex-py-patrick/examples
```

### 步骤2：设置环境变量

选择上述方式1或方式2设置环境变量。

### 步骤3：运行脚本

```bash
python arbitrage_btc_usdt.py
```

### 步骤4：查看输出

脚本会输出：
- 账户信息
- WebSocket连接状态
- 实时价格更新
- 交易执行情况

按 `Ctrl+C` 停止脚本。

## 📝 完整运行示例

```bash
# 1. 进入目录
cd /Users/patrick/Desktop/paradex-py/examples

# 2. 设置环境变量
export ACCOUNT1_L1_ADDRESS="0x1234..."
export ACCOUNT1_L1_PRIVATE_KEY="0xabcd..."
export ACCOUNT2_L1_ADDRESS="0x5678..."
export ACCOUNT2_L1_PRIVATE_KEY="0xef01..."

# 3. 运行脚本
python arbitrage_btc_usdt.py
```

## ✅ 验证配置

运行脚本后，如果看到以下输出，说明配置正确：

```
============================================================
BTC-USDT 套利策略启动
市场: BTC-USD-PERP
交易数量: 0.01
价差阈值: 0
============================================================
初始化账户1...
初始化账户2...
启动套利监控...
获取账户信息...
账户1信息:
  L2地址: 0x...
  账户摘要: ...
连接WebSocket...
WebSocket连接成功
订阅 BTC-USD-PERP 的BBO频道...
✅ 套利监控已启动，等待套利机会...
```

如果看到错误，请检查：

1. **环境变量未设置**：
   ```
   错误: 请设置环境变量 ACCOUNT1_L1_ADDRESS 和 ACCOUNT1_L1_PRIVATE_KEY
   ```
   → 检查环境变量是否正确设置（使用 `echo $ACCOUNT1_L1_ADDRESS` 验证）

2. **地址格式错误**：
   - 确保地址以 `0x` 开头
   - 地址应该是42个字符（0x + 40个十六进制字符）

3. **私钥格式错误**：
   - 确保私钥以 `0x` 开头
   - 私钥应该是66个字符（0x + 64个十六进制字符）

4. **账户未完成onboarding**：
   ```
   ValueError: Account not initialized
   ```
   → 需要先在Paradex上完成账户注册

## 🔧 常见问题

### Q1: 如何查看当前设置的环境变量？

```bash
echo $ACCOUNT1_L1_ADDRESS
echo $ACCOUNT1_L1_PRIVATE_KEY
```

### Q2: 如何清除环境变量？

```bash
unset ACCOUNT1_L1_ADDRESS
unset ACCOUNT1_L1_PRIVATE_KEY
unset ACCOUNT2_L1_ADDRESS
unset ACCOUNT2_L1_PRIVATE_KEY
```

### Q3: 如何在不同的终端会话中使用？

每次打开新终端都需要重新设置环境变量，或者：
- 将环境变量添加到 `~/.bashrc` 或 `~/.zshrc`（不推荐，因为会暴露私钥）
- 使用 `.env` 文件方式

### Q4: 私钥安全吗？

⚠️ **重要安全提示**：
- 不要将私钥提交到Git仓库
- 不要将私钥分享给他人
- 使用环境变量或 `.env` 文件（并确保 `.env` 在 `.gitignore` 中）
- 生产环境建议使用硬件钱包或密钥管理服务

### Q5: 如何切换到生产环境？

修改脚本中的环境设置：

```python
# 在 arbitrage_btc_usdt.py 中找到这一行：
from paradex_py.environment import TESTNET

# 改为：
from paradex_py.environment import PROD
```

或者：

```python
from paradex_py.environment import Environment

# 然后在创建 Paradex 实例时：
paradex = Paradex(
    env=Environment.PROD,  # 或 Environment.TESTNET
    ...
)
```

## 📊 运行效果示例

正常运行时，你会看到类似这样的输出：

```
BBO更新 - 买一: 50000.0, 卖一: 50001.0, 价差: 1.0
BBO更新 - 买一: 50000.5, 卖一: 50000.5, 价差: 0.0
============================================================
检测到套利机会！
买一价: 50000.5, 卖一价: 50000.5, 价差: 0.0
交易数量: 0.01
============================================================
账户1提交买单: BTC-USD-PERP NEW MARKET BUY 0.01/0.01
账户2提交卖单: BTC-USD-PERP NEW MARKET SELL 0.01/0.01
账户1买单提交成功: {'id': '...', 'status': 'NEW', ...}
账户2卖单提交成功: {'id': '...', 'status': 'NEW', ...}
✅ 套利交易成功执行！
交易统计 - 总计: 1, 成功: 1, 失败: 0
============================================================
```

## 🛠️ 调试技巧

1. **查看详细日志**：
   ```bash
   export LOG_FILE="true"
   python arbitrage_btc_usdt.py
   ```

2. **测试连接**：
   先运行 `call_rest_api.py` 测试账户配置是否正确

3. **检查网络**：
   确保能访问 Paradex API

4. **查看WebSocket消息**：
   脚本会输出所有BBO更新，可以观察价格变化

